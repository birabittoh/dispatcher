stages:
  - test
#  - build
  - docker

variables:
  COVERAGE_THRESHOLD: "75"
  IMAGE_NAME: "$CI_REGISTRY_IMAGE"
  IMAGE_TAG: "${CI_COMMIT_SHORT_SHA}"
  DIST_DIR: "dist"

test:
  stage: test
  image: golang:1.25
  script:
    - echo "Running tests with coverage..."
    - make test DIST_DIR=${DIST_DIR}
    - |
      # Extract coverage percentage from output
      COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
      echo "Current coverage: ${COVERAGE}%"
      echo "Minimum threshold: ${COVERAGE_THRESHOLD}%"
      
      # Compare with threshold (use bc for float comparison)
      if [ $(echo "$COVERAGE < $COVERAGE_THRESHOLD" | bc -l) -eq 1 ]; then
        echo "⚠️  WARNING: Coverage ${COVERAGE}% is below the threshold of ${COVERAGE_THRESHOLD}%"
        exit 0  # Exit successfully but show warning
      else
        echo "✓ Coverage OK: ${COVERAGE}% meets the threshold"
      fi
  allow_failure: false
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.out
    when: always

#build:
#  stage: build
#  image: golang:1.25
#  script:
#    - echo "Building executable..."
#    - DIST_DIR=${DIST_DIR} make build
#    - echo "Creating archive from ${DIST_DIR} folder..."
#    - tar -czf ${DIST_DIR}-${CI_COMMIT_SHORT_SHA}.tar.gz -C ${DIST_DIR} .
#    - ls -lh ${DIST_DIR}-${CI_COMMIT_SHORT_SHA}.tar.gz
#  artifacts:
#    name: "${DIST_DIR}-${CI_COMMIT_SHORT_SHA}"
#    paths:
#      - ${DIST_DIR}-${CI_COMMIT_SHORT_SHA}.tar.gz
#    expire_in: 30 days
#  dependencies:
#    - test

docker-build-push:
  stage: docker
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - echo "Logging in to GitLab Container Registry..."
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
  script:
    - echo "Building Docker image..."
    - docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .
    - docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${IMAGE_NAME}:latest
    - echo "Pushing image to registry..."
    - docker push ${IMAGE_NAME}:${IMAGE_TAG}
    - docker push ${IMAGE_NAME}:latest
    - echo "✓ Image pushed successfully:"
    - echo "  - ${IMAGE_NAME}:${IMAGE_TAG}"
    - echo "  - ${IMAGE_NAME}:latest"
  only:
    - main
    - develop
    - tags
